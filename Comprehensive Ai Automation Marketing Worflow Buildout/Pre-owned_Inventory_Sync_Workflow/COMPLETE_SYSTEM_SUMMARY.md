# Complete Pre-Owned Specials Automation System

**Last Updated:** December 1, 2025

---

## ðŸŽ¯ System Overview

This automated system syncs pre-owned vehicle inventory from Reynolds/MaxDigital FTP â†’ Google Sheets â†’ Customer.io for email marketing campaigns.

### Architecture

```
Reynolds FTP (35 CSV files, 2,470 vehicles)
    â†“
n8n Workflow (filters, transforms, generates URLs)
    â†“
Google Sheets (200-500 vehicles, Customer.io format)
    â†“
Google Apps Script (uploads to Customer.io)
    â†“
Customer.io Collections (email campaigns)
```

---

## ðŸ“¦ Components

### 1. n8n Workflow: "Pre-owned Inventory Sync"

**Purpose:** Pulls inventory from FTP, filters for specials, transforms to Customer.io format

**Trigger Options:**
- â° **Schedule**: Runs hourly automatically (720 times/month)
- ðŸ”˜ **Webhook**: Manual trigger via Google Apps Script button

**Flow:**
```
FTP List (68 files)
  â†’ Filter CSV (*U_INV.csv = 35 files)
  â†’ Download Files (35 CSVs, ~5-15MB)
  â†’ Parse CSV (2,470 vehicles)
  â†’ Filter Specials (7 filters â†’ ~800-1,200 vehicles)
  â†’ Generate URLs & Transform (14 vehicle fields to A-N)
  â†’ Filter by Stock List (P-Q columns â†’ ~200-500 vehicles)
  â†’ Clear Sheet (A2:N, preserves O, P-Q, R, S, T-AS)
  â†’ Append Data (14 fields to A-N)
  â†’ Log Success
```

**Execution Time:** ~55-70 seconds

**Files Created:**
- âœ… `workflow_updated.json` - Ready to import into n8n

---

### 2. Google Apps Script: Per-Dealer Upload Automation

**Purpose:** Provides manual control buttons for sync and upload operations

**Function 1: Sync from FTP**
- Triggers n8n webhook
- Pulls fresh inventory from Reynolds FTP
- Updates Google Sheet with filtered specials
- **Time:** 55-70 seconds

**Function 2: Upload to Customer.io (Per-Dealer)**
- Reads vehicle data from Google Sheet (columns A-AS)
- Includes core vehicle data (A-O) + subject lines (T-AS)
- Skips stock filter columns (P-Q) automatically
- Groups vehicles by `Dealer_Name` field
- Uploads each dealer to their specific collection with their specific API key
- Matches Python script's per-dealer upload logic exactly âœ…
- **Time:** 5-10 seconds for ~40 dealers

**Upload Process:**
1. Read all vehicles from sheet
2. Group by `Dealer_Name` field
3. For each dealer:
   - Find dealer config (API key + collection ID)
   - Upload dealer's vehicles to their collection
   - Use `PUT https://api.customer.io/v1/api/collections/{collectionId}`

**Custom Menu:**
```
ðŸš€ Inventory Sync
  â”œâ”€ ðŸ“ Sync from FTP
  â”œâ”€ â˜ï¸ Upload to Customer.io (All Dealers)
  â””â”€ ðŸ“Š View Sync Status
```

**Dealer Configuration:**
- 45 dealers configured with API keys and collection IDs
- Matches Python script's `.env` file exactly
- Sprinter dealers use Mercedes credentials (same as Python)

**Files Created:**
- âœ… `google_apps_script_per_dealer.gs` - Ready to paste into Google Sheets
- âœ… `google_apps_script.gs` - Original workspace version (deprecated)
- âœ… `google_apps_script_with_workspaces.gs` - Workspace version (deprecated)

---

### 3. Google Sheet: "Pre-Owned Specials Automation"

**Sheet ID:** `1PkU3Sh9fgWWaz25OqymT2P_EWzB_UvWghgrizTWjHlA`

**Data Structure:**

| Columns | Purpose | Count | Source |
|---------|---------|-------|--------|
| **A-N** | Core Vehicle Data | 14 fields | n8n workflow |
| **O** | Reserved | 1 field | Future use |
| **P-Q** | Stock Filters (Include/Exclude) | 2 fields | Manual entry |
| **R** | Reserved | 1 field | Future use |
| **S** | Timestamp | 1 field | Apps Script (on upload) |
| **T-AS** | Subject Lines & Preheaders | 26 fields | Manual entry |

**Core Vehicle Fields (A-N):**
- A: VIN
- B: Stock
- C: vehicle_name
- D: Dealer_Name
- E: VDP_URL_1
- F: Main_Photo
- G: Price_Is
- H: Price_Was
- I: Make
- J: Model
- K: Year
- L: Trim
- M: Mileage
- N: certified_pre_owned

**Reserved (O, R):**
- O: Reserved for future use
- R: Reserved/spacing

**Timestamp (S):**
- S: last_updated (added by Apps Script when uploading to Customer.io)

**Stock Filtering (P-Q):**
- **P (Stock_Include):** If not empty, only these stock numbers are used
- **Q (Stock_Exclude):** Always removed (highest priority, even if in include list)
- **Priority:** Exclude > Include > All vehicles
- **Minimum:** 12 vehicles guaranteed

**Subject Line Fields (T-AS):**
- 26 subject line/preheader fields for 3 email variations
- Must be manually added to sheet (not generated by workflow)
- Required for Customer.io upload
- See GOOGLE_SHEET_HEADERS.md for complete list

---

## ðŸ”„ Workflow Details

### Filtering Logic (7 Production Filters)

Matches Python script `inventory_sync.py` exactly:

1. **Condition Filter:** USED only (not NEW)
2. **Stock Required:** Must have stock number
3. **Price Range:** $2,001 - $99,999
4. **Mileage Filter:** â‰¥100 miles (excludes "coming soon")
5. **Price Validation:** Price_Was > Price_Is (valid discount)
6. **Required Fields:** VIN, image_link, link_template
7. **Min Field Count:** â‰¥10 fields total (data quality)

**Result:** ~2,470 â†’ ~800-1,200 vehicles passing filters

### URL Generation Logic

Matches Python script exactly:

**VIN-Based Dealers** (Always use VIN in search URL):
- Audi Anchorage
- Audi Bellingham
- Audi Oakland
- Audi Palo Alto

**Forced Generation** (Ignore FTP URL):
- Land Rover San Francisco

**Shared Inventory** (Generate dealer-specific URLs):
- JLR San Francisco
- Land Rover San Francisco

**All Others:**
- Use original FTP URL if available
- Generate if missing
- Remove `?store=` parameter

**Example:**
```javascript
// VIN-based (Audi)
Original: https://ftp-url.com/vehicle/12345?store=paloalto
Generated: https://www.audipaloalto.com/searchused.aspx?utype=U&search=WABC123456

// Stock-based (BMW)
Original: https://ftp-url.com/vehicle/67890
Generated: https://www.bmwseattle.com/searchused.aspx?utype=U&search=A12345
```

### Field Transformations

CSV â†’ Customer.io format:

| CSV Field | Customer.io Field | Transformation |
|-----------|------------------|----------------|
| `vin` | `VIN` | Uppercase |
| `stock` / `id` | `Stock` | As-is |
| `title` | `vehicle_name` | Remove "theme" |
| `link_template` | `VDP_URL_1` | Generate + normalize |
| `image_link` | `Main_Photo` | As-is |
| `price` | `Price_Is` | Format with commas |
| `vehicle_msrp` | `Price_Was` | Format with commas |
| `mileage` | `Mileage` | Format with commas |
| N/A | `Dealer_Name` | Extract from filename |
| N/A | 26 subject/preheader fields | Based on dealer type |

### Stock List Filtering (7-Step Process)

1. **Read Stock Filters** from Google Sheets columns AA-AB
2. **Remove Excluded** vehicles (highest priority)
3. **Check Include List** - if empty, use all (after exclusions)
4. **Match Include List** - filter to only these stocks
5. **Check Minimum** - need at least 12 vehicles
6. **Add More if Needed** - sort by price (highest first)
7. **Return Final List** - guaranteed 12+ vehicles

---

## ðŸš€ Setup Instructions

### Step 1: Import n8n Workflow

1. Open n8n Cloud
2. Create new workflow
3. Import `workflow_updated.json`
4. Configure FTP credentials (or use env variables):
   - FTP_HOST: `ftp.maxdigital.com`
   - FTP_USER: `109424_Google`
   - FTP_PASS: `nwdngmsS`
5. Configure Google Sheets OAuth:
   - Click "Clear Google Sheet" node
   - Connect Google account
   - Grant permissions
6. Activate workflow
7. Copy webhook URL from Webhook node

### Step 2: Install Google Apps Script

1. Open Google Sheet: "Pre-Owned Specials Automation"
2. Extensions â†’ Apps Script
3. Paste code from `google_apps_script_per_dealer.gs`
4. Configure Script Properties:
   - Click âš™ï¸ Project Settings
   - Scroll to "Script Properties"
   - Add property:
     - `N8N_WEBHOOK_URL`: (from Step 1.7)
   - **Note:** Dealer API keys and collection IDs are hardcoded in the script (from .env file)
5. Save and authorize
6. Refresh spreadsheet â†’ "ðŸš€ Inventory Sync" menu should appear

### Step 3: Test End-to-End

1. **Test FTP Sync:**
   - Click "ðŸš€ Inventory Sync" â†’ "ðŸ“ Sync from FTP"
   - Wait 55-70 seconds
   - Refresh sheet â†’ should see ~200-500 vehicles

2. **Test Stock Filters:**
   - Add stock numbers to column AA (include) or AB (exclude)
   - Click "ðŸ“ Sync from FTP" again
   - Verify filtering works

3. **Test Customer.io Upload:**
   - Click "ðŸš€ Inventory Sync" â†’ "â˜ï¸ Upload to Customer.io (All Dealers)"
   - Confirm upload
   - Wait 5-10 seconds for ~40 dealers to upload
   - Check results dialog â†’ should show success for each dealer
   - Check Customer.io collections â†’ each dealer should have their vehicles

---

## ðŸ“Š Expected Results

### Before Filters (Raw FTP Data)
- Files: 68 total on FTP
- Filtered: 35 files (*U_INV.csv)
- Vehicles: ~2,470 raw vehicles

### After Production Filters
- Condition: USED only
- Price: $2,001-$99,999
- Mileage: â‰¥100 miles
- Valid discount: Price_Was > Price_Is
- Required fields: VIN, image, URL
- Min fields: â‰¥10
- **Result:** ~800-1,200 vehicles

### After Stock List Filters
- Include list (AA): Optional whitelist
- Exclude list (AB): Blacklist (highest priority)
- Minimum: 12 vehicles guaranteed
- **Result:** ~200-500 final vehicles

### Final Output (from n8n workflow)
- Columns: 14 core vehicle fields (A-N)
- Format: All prices with commas, cleaned names, generated URLs
- Timestamp: last_updated added by Apps Script (column S) when uploading
- Subject Lines: NOT included (must be added to columns T-AS manually)
- Note: Apps Script uploads A-AS to Customer.io (vehicle data + subject lines + timestamp)

---

## ðŸŽ¨ Subject Line Logic

**IMPORTANT:** Subject lines are NOT generated by the n8n workflow. They must be manually added to Google Sheet columns AC-AZ.

### Email Variations

Each vehicle should have 26 subject line/preheader fields in columns AC-AZ:

**Original Email:**
- Luxury_Subject_Line
- Luxury_Preheader
- Lifestyle_Subject_Line
- Lifestyle_Preheader
- Alternative_Luxury_Subject_Line
- Alternative_Luxury_Preheader
- Alternative_Lifestyle_Subject_Line
- Alternative_Lifestyle_Preheader

**1st Follow-Up:**
- FollowUp1_Luxury_Subject_Line
- FollowUp1_Luxury_Preheader
- FollowUp1_Lifestyle_Subject_Line
- FollowUp1_Lifestyle_Preheader
- FollowUp1_Alternative_Luxury_Subject_Line
- FollowUp1_Alternative_Luxury_Preheader
- FollowUp1_Alternative_Lifestyle_Subject_Line
- FollowUp1_Alternative_Lifestyle_Preheader

**2nd Follow-Up:**
- FollowUp2_Luxury_Subject_Line
- FollowUp2_Luxury_Preheader
- FollowUp2_Lifestyle_Subject_Line
- FollowUp2_Lifestyle_Preheader
- FollowUp2_Alternative_Luxury_Subject_Line
- FollowUp2_Alternative_Luxury_Preheader
- FollowUp2_Alternative_Lifestyle_Subject_Line
- FollowUp2_Alternative_Lifestyle_Preheader

---

## ðŸ”§ Troubleshooting

### Issue 1: n8n Workflow Not Running

**Symptoms:**
- No data in Google Sheet
- Webhook returns error

**Solutions:**
1. Check workflow is activated (toggle in top right)
2. Verify FTP credentials are correct
3. Test FTP connection manually
4. Check execution history for errors

---

### Issue 2: Google Apps Script Button Missing

**Symptoms:**
- No "ðŸš€ Inventory Sync" menu

**Solutions:**
1. Refresh the spreadsheet
2. Check Apps Script is saved and authorized
3. Run `onOpen()` function manually from Apps Script
4. Check browser console for errors

---

### Issue 3: Customer.io Upload Fails

**Symptoms:**
- Error message about API key or collection

**Solutions:**
1. Verify Script Properties are set correctly:
   - CUSTOMERIO_API_KEY
   - CUSTOMERIO_SITE_ID
   - CUSTOMERIO_COLLECTION_ID
2. Check API key permissions in Customer.io
3. Verify collection ID exists
4. Check collection schema matches sheet fields

---

### Issue 4: Stock Filters Not Working

**Symptoms:**
- Excluded vehicles still appear
- Include list not honored

**Solutions:**
1. Check columns AA-AB have data
2. Verify stock numbers match exactly (case-insensitive)
3. Remember: Exclude has highest priority
4. Check "Filter by Stock List" node logs in n8n

---

## ðŸ“ˆ Monitoring & Maintenance

### Daily Checks

- âœ… Workflow executed successfully (check n8n history)
- âœ… Vehicle count is ~200-500 (reasonable range)
- âœ… No error emails from n8n

### Weekly Checks

- âœ… Review stock filters (AA-AB columns)
- âœ… Verify URL generation working (spot check VDP_URL_1)
- âœ… Check Customer.io collection has fresh data

### Monthly Checks

- âœ… Review filtering statistics in n8n logs
- âœ… Update subject lines if campaign changes
- âœ… Check FTP credentials haven't expired

---

## ðŸ”„ Migration from Python Script

This system **replaces** the Python script with:

| Python Component | New Component |
|-----------------|---------------|
| FTP Download | n8n FTP nodes |
| CSV Parsing | n8n Code node |
| 7 Production Filters | n8n "Filter Pre-Owned Specials" |
| URL Generation | n8n "Generate URLs & Transform" |
| Stock Filtering | n8n "Filter by Stock List" |
| Field Transformation | n8n "Generate URLs & Transform" |
| Per-Dealer Grouping | Google Apps Script `groupVehiclesByDealer()` |
| Customer.io Upload | Google Apps Script `uploadDealerToCustomerIO()` |

**Benefits:**
- âœ… Visual workflow (easier to understand)
- âœ… No Python installation needed
- âœ… Manual control via Google Sheets buttons
- âœ… Automatic hourly sync
- âœ… Better error handling
- âœ… Easier monitoring

---

## ðŸ“š File Reference

| File | Purpose | Location |
|------|---------|----------|
| `workflow_updated.json` | n8n workflow (ready to import) | This folder |
| `google_apps_script_per_dealer.gs` | **MAIN** Apps Script with per-dealer upload | This folder |
| `GOOGLE_SHEET_HEADERS.md` | **Sheet setup guide** - Column headers A-AS | This folder |
| `google_apps_script.gs` | Original Apps Script (deprecated) | This folder |
| `google_apps_script_with_workspaces.gs` | Workspace version (deprecated) | This folder |
| `PRE_OWNED_INVENTORY_SYNC_README.md` | Detailed workflow docs | This folder |
| `COMPLETE_SYSTEM_SUMMARY.md` | This document | This folder |
| `workflow_backup_before_changes.json` | Backup of original | This folder |
| `ftp_probe.py` | FTP server explorer (optional) | Root folder |

---

## âœ… Next Steps

1. **Set up Google Sheet headers** (see `GOOGLE_SHEET_HEADERS.md`)
   - Copy headers from GOOGLE_SHEET_HEADERS.md into row 1
   - Columns A-O: Vehicle data headers
   - Columns P-Q: Stock_Include, Stock_Exclude
   - Columns T-AS: Subject line headers
2. **Import n8n workflow** from `workflow_updated.json`
3. **Install Apps Script** from `google_apps_script_per_dealer.gs`
4. **Configure credentials** (FTP, Google OAuth, n8n webhook URL)
5. **Add subject line data** to columns T-AS (manual entry or formulas)
6. **Test FTP sync** button
7. **Test Customer.io upload** button (uploads to all 45 dealers automatically)
8. **Verify end-to-end** flow works
9. **Decommission Python script** âœ…

**Note:** All dealer API keys and collection IDs are already configured in the Apps Script from your `.env` file!

---

**System Status:** âœ… Ready for Production

**Last Modified:** December 1, 2025

**Built with:** n8n Cloud + Google Apps Script + Claude Code
