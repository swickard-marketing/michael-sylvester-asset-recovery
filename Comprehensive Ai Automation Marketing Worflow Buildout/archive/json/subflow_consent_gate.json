{
  "name": "Consent-Gate",
  "active": false,
  "nodes": [
    { "parameters": {}, "id": "In", "name": "Execute Workflow Trigger", "type": "n8n-nodes-base.executeWorkflowTrigger", "typeVersion": 1, "position": [260, 200] },
    { "parameters": { "operation":"runQuery", "query": "SELECT allowed FROM compliance.optins WHERE contactId = @contactId AND channel = @channel", "additionalFields": {"useLegacySql": false} }, "id":"Optin", "name":"Check Opt-in", "type":"n8n-nodes-base.googleBigQuery", "typeVersion":2, "position":[480,160] },
    { "parameters": { "operation":"runQuery", "query": "SELECT 1 as suppressed FROM compliance.suppression WHERE contactId = @contactId AND channel = @channel", "additionalFields": {"useLegacySql": false} }, "id":"Supp", "name":"Check Suppression", "type":"n8n-nodes-base.googleBigQuery", "typeVersion":2, "position":[480,240] },
    { "parameters": { "functionCode": "const hasOptIn = (items[0]?.json?.rows||[]).length>0;\nconst suppressed = (items[1]?.json?.rows||[]).length>0;\nreturn [{ json: { allowed: hasOptIn && !suppressed, reason: hasOptIn ? (suppressed?'suppressed':'ok') : 'no_optin' } }];" }, "id":"Eval", "name":"Evaluate", "type":"n8n-nodes-base.function", "typeVersion":2, "position":[700,200] }
  ],
  "connections": {
    "Execute Workflow Trigger": { "main": [[{ "node": "Check Opt-in", "type": "main", "index": 0 }, { "node": "Check Suppression", "type": "main", "index": 0 }]] },
    "Check Opt-in": { "main": [[{ "node": "Evaluate", "type": "main", "index": 0 }]] },
    "Check Suppression": { "main": [[{ "node": "Evaluate", "type": "main", "index": 1 }]] }
  }
}


